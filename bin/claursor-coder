#!/usr/bin/env bash
# ClauRsor - When Claude and Cursor code together
# Author: Mike Lopez <e@mikelopez.com>
# Copyright (C) 2026 Mike Lopez <e@mikelopez.com>
# SPDX-License-Identifier: GPL-2.0-only

set -euo pipefail

echo "ClauRsor - When Claude and Cursor code together"
echo

BRANCH="${1:-}"
if [[ -z "$BRANCH" ]]; then
  PROMPT="/plan-it $*"
else
  PROMPT="/plan-it ${*:2}"
fi

if [[ -z "${PROMPT#"/plan-it "}" ]]; then
  echo "Usage: $0 [branch-name] <prompt...>" >&2
  exit 1
fi

echo Prompt: $PROMPT
echo

# Fail early if tools aren't installed
command -v git          >/dev/null || { echo "git not found in PATH"          >&2; exit 127; }
command -v gh           >/dev/null || { echo "gh not found in PATH"           >&2; exit 127; }
command -v claude       >/dev/null || { echo "claude not found in PATH"       >&2; exit 127; }
command -v cursor-agent >/dev/null || { echo "cursor-agent not found in PATH" >&2; exit 127; }

MAX_TRIES="${MAX_TRIES:-20}"
SLEEP_SECS="${SLEEP_SECS:-0.2}"
CURSOR_BASE_ARGS="--trust --print --model gpt-5.3-codex-high"

review_loop() {
  local label="$1"
  local file="$2"
  local claude_cmd="$3"

  local tries=0

  echo "$label review loop started..."
  until [[ -f "$file" ]] && grep -q 'ALL GOOD' "$file"; do
    tries=$((tries + 1))
    if (( tries >= MAX_TRIES )); then
      echo "Gave up after $MAX_TRIES tries (no 'ALL GOOD' in $file)" >&2
      exit 2
    fi

    echo "- Loop: $tries"
    echo "- Claude is updating $label..."
    claude -c -p "$claude_cmd" >/dev/null 2>&1

    echo "- Cursor is reviewing the $label again..."
    if [[ "$label" == "Plan" ]]; then
      cursor-agent $CURSOR_BASE_ARGS --continue '/plan-review' >/dev/null 2>&1
    else
      cursor-agent $CURSOR_BASE_ARGS --continue '/code-review' >/dev/null 2>&1
    fi

    sleep "$SLEEP_SECS"
  done

  echo "$label is good!"
}

if [[ -z "$BRANCH" ]]; then
  BRANCH="$(git rev-parse --abbrev-ref HEAD)"
  echo "Using current branch $BRANCH"
else
  echo "Creating Branch: $BRANCH"
  git checkout -b "$BRANCH"
fi

BRANCH_PATH="${BRANCH//\//_}"
PLAN_FILE=".ai/branches/${BRANCH_PATH}/plan-review.md"
CODE_FILE=".ai/branches/${BRANCH_PATH}/code-review.md"

echo
echo "Claude is planning..."
claude -p "$PROMPT" >/dev/null 2>&1

echo "Cursor is reviewing the plan..."
cursor-agent $CURSOR_BASE_ARGS '/plan-review' >/dev/null 2>&1

review_loop "Plan" "$PLAN_FILE" "/plan-update"

echo
echo "Claude is coding it out..."
claude -c -p "/code-it" >/dev/null 2>&1

echo "Cursor is reviewing Claude's code..."
cursor-agent $CURSOR_BASE_ARGS --continue '/code-review' >/dev/null 2>&1

review_loop "Code" "$CODE_FILE" "/code-fix"

echo "Claude and Cursor are done working together."
